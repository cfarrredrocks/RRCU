/*
--==================================================================================================
--Author: Farr, C
--Create Date:	2024-04-11 	
--Object Name:	sp_LOAD_T_LOAN_REQUEST_STG
--Description:  Loading LOAN_REQUEST Data
--***********************************************************************************************************************
--Date			Trello#					ChangedBy						Description 
------------------------------------------------------------------------------------------------------------------------
*/

CREATE OR REPLACE PROCEDURE RRCU_STG_DEV.KEYSTONE_CORE.sp_LOAD_T_LOAN_REQUEST_STG()
RETURNS VARCHAR NOT NULL
LANGUAGE SQL

AS
$$

BEGIN 
	
	TRUNCATE TABLE RRCU_STG_DEV.KEYSTONE_CORE.T_KS_LOAN_REQUEST_STG_CF;
	
	-- REMOVE PK	
	ALTER TABLE RRCU_STG_DEV.KEYSTONE_CORE.T_KS_LOAN_REQUEST_STG_CF DROP PRIMARY KEY;
	
	-- Populate STAGING WITH CTE DATA
	INSERT INTO RRCU_STG_DEV.KEYSTONE_CORE.T_KS_LOAN_REQUEST_STG_CF
	(
	SERIAL,
	SOURCEHASH2,
	PARENT_SERIAL, 
	ORDINAL, 
	LAST_FM_DATE, 
	ID, 
	DESCRIPTION, 
	TYPE_SERIAL, 
	BRANCH_SERIAL, 
	CRED_REP_PRIMARY_ECOA_CODE, 
	CRED_REP_ACCOUNT_TYPE, 
	CRED_REP_PORTFOLIO_TYPE_OVR, 
	SHARED_BRANCH_OPTION, 
	SOURCE_LOAN_SERIAL, 
	PROJECTION_DESCRIPTION, 
	PROJECTION_METHOD, 
	MATURITY_DATE, 
	PURPOSE_SERIAL, 
	PROCESSOR_USER_SERIAL, 
	APPROVAL_OFFICER_SERIAL, 
	APPROVAL_DATE, 
	APPROVED_LOAN_SERIAL, 
	CREDIT_SCORE_CATEGORY, 
	CREDIT_SCORE, 
	PAPER_GRADE_SERIAL, 
	COLLATERAL_TYPE_SERIAL,
	NOTE_NUMBER, 
	MINIMUM_BALANCE, 
	MINIMUM_ADVANCE, 
	DOWN_PAYMENT, 
	CREDIT_LIMIT, 
	CREDIT_LIMIT_EXPIRATION_DATE, 
	CREDIT_LIMIT_SHARED_GRP_SERIAL, 
	CC_CASH_ADV_LIMIT_PERCENTAGE, 
	CC_CASH_ADV_LIMIT_AMOUNT, 
	POSITIVE_PAY_OPTION, 
	DRAW_PERIOD_EXPIRATION_DATE, 
	MAX_VALUATION_CREDIT_LIMIT, 
	SHARE_SECURED_OPTION, 
	SHARE_SECURED_AMOUNT, 
	PAYMENT_METHOD, 
	PAYMENT_AMOUNT, 
	PAYMENT_CALCULATION_SERIAL, 
	PAYMENT_CALCULATION_SCH_FREQ, 
	PAYMENT_CALCULATION_SCH_FREQ_1, 
	PAYMENT_CALCULATION_SCH_PERIOD, 
	PAYMENT_CALCULATION_SCH_DATE, 
	PAYMENT_COUNT_SCHEDULED, 
	PAYMENT_FREQUENCY, 
	PAYMENT_FREQUENCY_DAY_1, 
	PAYMENT_FREQUENCY_DAY_2, 
	PAYMENT_SKIP_COUNT, 
	PAYMENT_SKIP_START_MONTH, 
	PAYMENT_SKIP_START_DAY, 
	PAYMENT_AHEAD, 
	PAYMENT_AHEAD_COUNT, 
	PAYMENT_DUE_DATE, 
	BALLOON_DATE, 
	BALLOON_AMOUNT, 
	INTEREST_PREPAID, 
	INTEREST_CALCULATION_DATE, 
	INTEREST_RATE, 
	INTEREST_APR, 
	INTEREST_RATE_VAR_OPT, 
	INTEREST_RATE_INDEX_SERIAL, 
	INTEREST_RATE_MARGIN, 
	INTEREST_RATE_DISCOUNT, 
	INTEREST_RATE_RISK_PREMIUM, 
	INTEREST_RATE_MINIMUM, 
	INTEREST_RATE_MAXIMUM, 
	INTEREST_RATE_CHG_START_DATE, 
	INTEREST_RATE_CHG_SCH_FREQ, 
	INTEREST_RATE_CHG_SCH_FREQ_1, 
	INTEREST_RATE_CHG_SCH_FREQ_2, 
	INTEREST_RATE_CHG_SCH_PERIOD, 
	INTEREST_RATE_CHG_SCH_DATE, 
	INTEREST_RATE_CHG_SCH_RND_INC, 
	INTEREST_RATE_CHG_SCH_RND_OPT, 
	INTEREST_RATE_CAP_FREQUENCY, 
	INTEREST_RATE_CAP_PERIOD, 
	INTEREST_RATE_CAP_DIRECTION, 
	INTEREST_RATE_CAP_START_DATE, 
	INTEREST_RATE_CAP_START_RATE, 
	INTEREST_RATE_CAP, 
	INTEREST_RATE_ADJUSTMENT, 
	INTEREST_RATE_ADJ_RSN_SERIAL, 
	LATE_FEE_CALCULATION_SERIAL, 
	MAINTENANCE_FEE_SERIAL, 
	MAINTENANCE_FEE_EFFECT_DATE, 
	MAINTENANCE_FEE_EXPIRE_DATE, 
	IMPOUND_AMOUNT, 
	IMPOUND_SHARE_SERIAL, 
	FASB_91_TYPE_SERIAL, 
	FASB_91_ORIGINAL_APR, 
	FASB_91_EFFECTIVE_APR, 
	FASB_91_UNAMORTIZED_FEES, 
	FASB_91_AMORTIZATION_AMOUNT, 
	FASB_91_FUNDING_OPTION, 
	MAIL_PERSON_ADDR_LINK_SERIAL, 
	STMT_MAIL_GROUP_SERIAL, 
	STMT_CUTOFF_GROUP_SERIAL, 
	CC_PURCH_INT_RATE, 
	CC_PURCH_INT_RATE_VAR_OPT, 
	CC_CASH_ADV_INT_RATE, 
	CC_CASH_ADV_INT_RATE_VAR_OPT, 
	CC_BAL_XFR_INT_RATE, 
	CC_BAL_XFR_INT_RATE_VAR_OPT, 
	CC_FIRST_YEAR_FEES_MAXIMUM, 
	CC_PENALTY_INT_RATE, 
	PROMO_RATE_TYPE_SERIAL, 
	SEGMENT_COUNT_LIMIT, 
	TAX_PERSON_SERIAL, 
	MLA_LIMITATION, 
	LIFE_INSURANCE_SERIAL, 
	DISABILITY_INSURANCE_SERIAL, 
	SINGLE_PREMIUM_LIFE, 
	SINGLE_PREMIUM_DISABILITY, 
	INSURANCE_METHOD, 
	INSURANCE_SHARE_SERIAL, 
	WITHDRAWN_INDICATOR, 
	CONTRACT_DATE, 
	SHARED_COLLATERAL_OPTION
	)
	
	WITH CTE AS

	(	
	SELECT 
	SERIAL,
	MD5(TO_VARCHAR(ARRAY_CONSTRUCT(*))) AS SourceHash2,  -- SOURCE HASH	
	PARENT_SERIAL, 
	ORDINAL, 
	LAST_FM_DATE, 
	ID, 
	DESCRIPTION, 
	TYPE_SERIAL, 
	BRANCH_SERIAL, 
	CRED_REP_PRIMARY_ECOA_CODE, 
	CRED_REP_ACCOUNT_TYPE, 
	CRED_REP_PORTFOLIO_TYPE_OVR, 
	SHARED_BRANCH_OPTION, 
	SOURCE_LOAN_SERIAL, 
	PROJECTION_DESCRIPTION, 
	PROJECTION_METHOD, 
	MATURITY_DATE, 
	PURPOSE_SERIAL, 
	PROCESSOR_USER_SERIAL, 
	APPROVAL_OFFICER_SERIAL, 
	APPROVAL_DATE, 
	APPROVED_LOAN_SERIAL, 
	CREDIT_SCORE_CATEGORY, 
	CREDIT_SCORE, 
	PAPER_GRADE_SERIAL, 
	COLLATERAL_TYPE_SERIAL,
	NOTE_NUMBER, 
	MINIMUM_BALANCE, 
	MINIMUM_ADVANCE, 
	DOWN_PAYMENT, 
	CREDIT_LIMIT, 
	CREDIT_LIMIT_EXPIRATION_DATE, 
	CREDIT_LIMIT_SHARED_GRP_SERIAL, 
	CC_CASH_ADV_LIMIT_PERCENTAGE, 
	CC_CASH_ADV_LIMIT_AMOUNT, 
	POSITIVE_PAY_OPTION, 
	DRAW_PERIOD_EXPIRATION_DATE, 
	MAX_VALUATION_CREDIT_LIMIT, 
	SHARE_SECURED_OPTION, 
	SHARE_SECURED_AMOUNT, 
	PAYMENT_METHOD, 
	PAYMENT_AMOUNT, 
	PAYMENT_CALCULATION_SERIAL, 
	PAYMENT_CALCULATION_SCH_FREQ, 
	PAYMENT_CALCULATION_SCH_FREQ_1, 
	PAYMENT_CALCULATION_SCH_PERIOD, 
	PAYMENT_CALCULATION_SCH_DATE, 
	PAYMENT_COUNT_SCHEDULED, 
	PAYMENT_FREQUENCY, 
	PAYMENT_FREQUENCY_DAY_1, 
	PAYMENT_FREQUENCY_DAY_2, 
	PAYMENT_SKIP_COUNT, 
	PAYMENT_SKIP_START_MONTH, 
	PAYMENT_SKIP_START_DAY, 
	PAYMENT_AHEAD, 
	PAYMENT_AHEAD_COUNT, 
	PAYMENT_DUE_DATE, 
	BALLOON_DATE, 
	BALLOON_AMOUNT, 
	INTEREST_PREPAID, 
	INTEREST_CALCULATION_DATE, 
	INTEREST_RATE, 
	INTEREST_APR, 
	INTEREST_RATE_VAR_OPT, 
	INTEREST_RATE_INDEX_SERIAL, 
	INTEREST_RATE_MARGIN, 
	INTEREST_RATE_DISCOUNT, 
	INTEREST_RATE_RISK_PREMIUM, 
	INTEREST_RATE_MINIMUM, 
	INTEREST_RATE_MAXIMUM, 
	INTEREST_RATE_CHG_START_DATE, 
	INTEREST_RATE_CHG_SCH_FREQ, 
	INTEREST_RATE_CHG_SCH_FREQ_1, 
	INTEREST_RATE_CHG_SCH_FREQ_2, 
	INTEREST_RATE_CHG_SCH_PERIOD, 
	INTEREST_RATE_CHG_SCH_DATE, 
	INTEREST_RATE_CHG_SCH_RND_INC, 
	INTEREST_RATE_CHG_SCH_RND_OPT, 
	INTEREST_RATE_CAP_FREQUENCY, 
	INTEREST_RATE_CAP_PERIOD, 
	INTEREST_RATE_CAP_DIRECTION, 
	INTEREST_RATE_CAP_START_DATE, 
	INTEREST_RATE_CAP_START_RATE, 
	INTEREST_RATE_CAP, 
	INTEREST_RATE_ADJUSTMENT, 
	INTEREST_RATE_ADJ_RSN_SERIAL, 
	LATE_FEE_CALCULATION_SERIAL, 
	MAINTENANCE_FEE_SERIAL, 
	MAINTENANCE_FEE_EFFECT_DATE, 
	MAINTENANCE_FEE_EXPIRE_DATE, 
	IMPOUND_AMOUNT, 
	IMPOUND_SHARE_SERIAL, 
	FASB_91_TYPE_SERIAL, 
	FASB_91_ORIGINAL_APR, 
	FASB_91_EFFECTIVE_APR, 
	FASB_91_UNAMORTIZED_FEES, 
	FASB_91_AMORTIZATION_AMOUNT, 
	FASB_91_FUNDING_OPTION, 
	MAIL_PERSON_ADDR_LINK_SERIAL, 
	STMT_MAIL_GROUP_SERIAL, 
	STMT_CUTOFF_GROUP_SERIAL, 
	CC_PURCH_INT_RATE, 
	CC_PURCH_INT_RATE_VAR_OPT, 
	CC_CASH_ADV_INT_RATE, 
	CC_CASH_ADV_INT_RATE_VAR_OPT, 
	CC_BAL_XFR_INT_RATE, 
	CC_BAL_XFR_INT_RATE_VAR_OPT, 
	CC_FIRST_YEAR_FEES_MAXIMUM, 
	CC_PENALTY_INT_RATE, 
	PROMO_RATE_TYPE_SERIAL, 
	SEGMENT_COUNT_LIMIT, 
	TAX_PERSON_SERIAL, 
	MLA_LIMITATION, 
	LIFE_INSURANCE_SERIAL, 
	DISABILITY_INSURANCE_SERIAL, 
	SINGLE_PREMIUM_LIFE, 
	SINGLE_PREMIUM_DISABILITY, 
	INSURANCE_METHOD, 
	INSURANCE_SHARE_SERIAL, 
	WITHDRAWN_INDICATOR, 
	CONTRACT_DATE, 
	SHARED_COLLATERAL_OPTION,
	ROW_NUMBER() OVER (PARTITION BY SERIAL ORDER BY SERIAL) AS rn -- helps identify mutliple serial number dupes		
	FROM RRCU_STG_DEV.KEYSTONE_CORE.T_KS_LOAN_REQUEST_STG
	)

	SELECT SERIAL, SOURCEHASH2, PARENT_SERIAL, ORDINAL, LAST_FM_DATE, ID, DESCRIPTION, TYPE_SERIAL, BRANCH_SERIAL, CRED_REP_PRIMARY_ECOA_CODE, CRED_REP_ACCOUNT_TYPE, CRED_REP_PORTFOLIO_TYPE_OVR, 
	SHARED_BRANCH_OPTION, SOURCE_LOAN_SERIAL, PROJECTION_DESCRIPTION, PROJECTION_METHOD, MATURITY_DATE, PURPOSE_SERIAL, PROCESSOR_USER_SERIAL, APPROVAL_OFFICER_SERIAL, 
	APPROVAL_DATE, APPROVED_LOAN_SERIAL, CREDIT_SCORE_CATEGORY, CREDIT_SCORE, PAPER_GRADE_SERIAL, COLLATERAL_TYPE_SERIAL, NOTE_NUMBER, MINIMUM_BALANCE, MINIMUM_ADVANCE, 
	DOWN_PAYMENT, CREDIT_LIMIT, CREDIT_LIMIT_EXPIRATION_DATE, CREDIT_LIMIT_SHARED_GRP_SERIAL, CC_CASH_ADV_LIMIT_PERCENTAGE, CC_CASH_ADV_LIMIT_AMOUNT, POSITIVE_PAY_OPTION, 
	DRAW_PERIOD_EXPIRATION_DATE, MAX_VALUATION_CREDIT_LIMIT, SHARE_SECURED_OPTION, SHARE_SECURED_AMOUNT, PAYMENT_METHOD, PAYMENT_AMOUNT, PAYMENT_CALCULATION_SERIAL, 
	PAYMENT_CALCULATION_SCH_FREQ, PAYMENT_CALCULATION_SCH_FREQ_1, PAYMENT_CALCULATION_SCH_PERIOD, PAYMENT_CALCULATION_SCH_DATE, PAYMENT_COUNT_SCHEDULED, PAYMENT_FREQUENCY, 
	PAYMENT_FREQUENCY_DAY_1, PAYMENT_FREQUENCY_DAY_2, PAYMENT_SKIP_COUNT, PAYMENT_SKIP_START_MONTH, PAYMENT_SKIP_START_DAY, PAYMENT_AHEAD, PAYMENT_AHEAD_COUNT, 
	PAYMENT_DUE_DATE, BALLOON_DATE, BALLOON_AMOUNT, INTEREST_PREPAID, INTEREST_CALCULATION_DATE, INTEREST_RATE, INTEREST_APR, INTEREST_RATE_VAR_OPT, 
	INTEREST_RATE_INDEX_SERIAL, INTEREST_RATE_MARGIN, INTEREST_RATE_DISCOUNT, INTEREST_RATE_RISK_PREMIUM, INTEREST_RATE_MINIMUM, INTEREST_RATE_MAXIMUM, 
	INTEREST_RATE_CHG_START_DATE, INTEREST_RATE_CHG_SCH_FREQ, INTEREST_RATE_CHG_SCH_FREQ_1, INTEREST_RATE_CHG_SCH_FREQ_2, INTEREST_RATE_CHG_SCH_PERIOD, 
	INTEREST_RATE_CHG_SCH_DATE, INTEREST_RATE_CHG_SCH_RND_INC, INTEREST_RATE_CHG_SCH_RND_OPT, INTEREST_RATE_CAP_FREQUENCY, INTEREST_RATE_CAP_PERIOD, 
	INTEREST_RATE_CAP_DIRECTION, INTEREST_RATE_CAP_START_DATE, INTEREST_RATE_CAP_START_RATE, INTEREST_RATE_CAP, INTEREST_RATE_ADJUSTMENT, INTEREST_RATE_ADJ_RSN_SERIAL, 
	LATE_FEE_CALCULATION_SERIAL, MAINTENANCE_FEE_SERIAL, MAINTENANCE_FEE_EFFECT_DATE, MAINTENANCE_FEE_EXPIRE_DATE, IMPOUND_AMOUNT, IMPOUND_SHARE_SERIAL, 
	FASB_91_TYPE_SERIAL, FASB_91_ORIGINAL_APR, FASB_91_EFFECTIVE_APR, FASB_91_UNAMORTIZED_FEES, FASB_91_AMORTIZATION_AMOUNT, FASB_91_FUNDING_OPTION, 
	MAIL_PERSON_ADDR_LINK_SERIAL, STMT_MAIL_GROUP_SERIAL, STMT_CUTOFF_GROUP_SERIAL, CC_PURCH_INT_RATE, CC_PURCH_INT_RATE_VAR_OPT, CC_CASH_ADV_INT_RATE, 
	CC_CASH_ADV_INT_RATE_VAR_OPT, CC_BAL_XFR_INT_RATE, CC_BAL_XFR_INT_RATE_VAR_OPT, CC_FIRST_YEAR_FEES_MAXIMUM, CC_PENALTY_INT_RATE, PROMO_RATE_TYPE_SERIAL, 
	SEGMENT_COUNT_LIMIT, TAX_PERSON_SERIAL, MLA_LIMITATION, LIFE_INSURANCE_SERIAL, DISABILITY_INSURANCE_SERIAL, SINGLE_PREMIUM_LIFE, SINGLE_PREMIUM_DISABILITY, 
	INSURANCE_METHOD, INSURANCE_SHARE_SERIAL, WITHDRAWN_INDICATOR, CONTRACT_DATE, SHARED_COLLATERAL_OPTION
	FROM CTE
	WHERE rn = 1;

-- DUPE CHECK / DELETE 
	DELETE FROM RRCU_STG_DEV.KEYSTONE_CORE.T_KS_LOAN_REQUEST_STG_CF USING (
    	WITH CTE_DUP AS
    	(
    	SELECT SERIAL,
	 	ROW_NUMBER () OVER ( PARTITION BY SERIAL ORDER BY SERIAL) AS RN
	 	FROM RRCU_STG_DEV.KEYSTONE_CORE.T_KS_LOAN_REQUEST_STG_CF
    	)
        SELECT SERIAL, RN FROM CTE_DUP
        ) AS CTE_RESULT
	WHERE CTE_RESULT.RN > 1;

	-- ADD PRIMARY KEY BACK

	ALTER TABLE RRCU_STG_DEV.KEYSTONE_CORE.T_KS_LOAN_REQUEST_STG_CF ADD PRIMARY KEY (SERIAL);

	-- Expiration for records not coming back into resultset
	UPDATE RRCU_DW_DEV.DW.T_KS_LOAN_REQUEST_DW_CF
	SET LNRQ_CURR_IND = 0
	, LNRQ_EXP_DT = CURRENT_DATE
	WHERE LNRQ_CURR_IND = 1
	AND LNRQ_SERIAL NOT IN (SELECT SERIAL FROM RRCU_STG_DEV.KEYSTONE_CORE.T_KS_LOAN_REQUEST_STG_CF);

	DROP TABLE IF EXISTS RRCU_STG_DEV.KEYSTONE_CORE.Update_STG;

	CREATE TEMPORARY TABLE RRCU_STG_DEV.KEYSTONE_CORE.Update_STG(
	LNRQ_REC_KEY BIGINT,
	STG_SOURCEHASH2 VARCHAR(32),
	NEW_SOURCEHASH2 VARCHAR(32),
	IS_TYPE2 INT,  -- REPRESENTS TYPE 2
	IS_NEW INT -- INDICATION FOR NEW RECORD TYPE 2
	);


	INSERT INTO RRCU_STG_DEV.KEYSTONE_CORE.Update_STG (
	LNRQ_REC_KEY,
	STG_SOURCEHASH2,
	NEW_SOURCEHASH2,
	IS_NEW,
	IS_TYPE2	
	)
	
	WITH CTE_COMPARE AS
	(
	SELECT dim.LNRQ_REC_KEY ,  dim.LNRQ_SOURCEHASH2, stg.sourcehash2,
	CASE WHEN dim.LNRQ_REC_KEY IS NULL THEN 1 ELSE 0 END CASE,
	CASE WHEN dim.LNRQ_REC_KEY IS NOT NULL AND stg.SOURCEHASH2 <> dim.LNRQ_SOURCEHASH2 THEN 1 ELSE 0 END CASE
	FROM RRCU_STG_DEV.KEYSTONE_CORE.T_KS_LOAN_REQUEST_STG_CF stg
	LEFT OUTER JOIN RRCU_DW_DEV.DW.T_KS_LOAN_REQUEST_DW_CF dim ON dim.LNRQ_SERIAL = stg.SERIAL AND dim.LNRQ_CURR_IND  = 1
	)
	SELECT *
	FROM CTE_COMPARE;

	UPDATE RRCU_STG_DEV.KEYSTONE_CORE.T_KS_LOAN_REQUEST_STG_CF a
	SET LNRQ_REC_KEY = b.LNRQ_REC_KEY,
	ISNEW = b.IS_NEW,
	ISTYPE2 = b.IS_TYPE2
	FROM (SELECT LNRQ_REC_KEY, IS_NEW, IS_TYPE2, NEW_SOURCEHASH2 FROM RRCU_STG_DEV.KEYSTONE_CORE.Update_STG) b
	WHERE a.SOURCEHASH2 = b.NEW_SOURCEHASH2 AND a.LNRQ_REC_KEY IS NULL;

	-- Expiration for records type 2
	
   UPDATE RRCU_DW_DEV.DW.T_KS_LOAN_REQUEST_DW_CF
	SET LNRQ_CURR_IND = 0
	, LNRQ_EXP_DT = CURRENT_DATE
	WHERE LNRQ_CURR_IND = 1
	AND LNRQ_SERIAL IN (SELECT SERIAL FROM RRCU_STG_DEV.KEYSTONE_CORE.T_KS_LOAN_REQUEST_STG_CF WHERE ISTYPE2 = 1); 

	INSERT INTO RRCU_DW_DEV.DW.T_KS_LOAN_REQUEST_DW_CF
	(
	LNRQ_SERIAL,
	LNRQ_CURR_IND, 
	LNRQ_EFF_DT, 
	LNRQ_EXP_DT, 
	--LNRQ_MOD_DT, 
	LNRQ_SOURCEHASH2, 
	LNRQ_PARENT_SERIAL,
	LNRQ_ORDINAL, 
	LNRQ_LAST_FM_DATE, 
	LNRQ_ID, 
	LNRQ_DESCRIPTION, 
	LNRQ_TYPE_SERIAL, 
	LNRQ_BRANCH_SERIAL, 
	LNRQ_CRED_REP_PRIMARY_ECOA_CODE, 
	LNRQ_CRED_REP_ACCOUNT_TYPE, 
	LNRQ_CRED_REP_PORTFOLIO_TYPE_OVR, 
	LNRQ_SHARED_BRANCH_OPTION, 
	LNRQ_SOURCE_LOAN_SERIAL, 
	LNRQ_PROJECTION_DESCRIPTION, 
	LNRQ_PROJECTION_METHOD, 
	LNRQ_MATURITY_DATE, 
	LNRQ_PURPOSE_SERIAL, 
	LNRQ_PROCESSOR_USER_SERIAL, 
	LNRQ_APPROVAL_OFFICER_SERIAL, 
	LNRQ_APPROVAL_DATE, 
	LNRQ_APPROVED_LOAN_SERIAL, 
	LNRQ_CREDIT_SCORE_CATEGORY, 
	LNRQ_CREDIT_SCORE, 
	LNRQ_PAPER_GRADE_SERIAL, 
	LNRQ_COLLATERAL_TYPE_SERIAL, 
	LNRQ_NOTE_NUMBER, 
	LNRQ_MINIMUM_BALANCE, 
	LNRQ_MINIMUM_ADVANCE, 
	LNRQ_DOWN_PAYMENT, 
	LNRQ_CREDIT_LIMIT, 
	LNRQ_CREDIT_LIMIT_EXPIRATION_DATE, 
	LNRQ_CREDIT_LIMIT_SHARED_GRP_SERIAL, 
	LNRQ_CC_CASH_ADV_LIMIT_PERCENTAGE, 
	LNRQ_CC_CASH_ADV_LIMIT_AMOUNT, 
	LNRQ_POSITIVE_PAY_OPTION, 
	LNRQ_DRAW_PERIOD_EXPIRATION_DATE, 
	LNRQ_MAX_VALUATION_CREDIT_LIMIT, 
	LNRQ_SHARE_SECURED_OPTION, 
	LNRQ_SHARE_SECURED_AMOUNT, 
	LNRQ_PAYMENT_METHOD, 
	LNRQ_PAYMENT_AMOUNT, 
	LNRQ_PAYMENT_CALCULATION_SERIAL, 
	LNRQ_PAYMENT_CALCULATION_SCH_FREQ, 
	LNRQ_PAYMENT_CALCULATION_SCH_FREQ_1, 
	LNRQ_PAYMENT_CALCULATION_SCH_PERIOD, 
	LNRQ_PAYMENT_CALCULATION_SCH_DATE, 
	LNRQ_PAYMENT_COUNT_SCHEDULED, 
	LNRQ_PAYMENT_FREQUENCY, 
	LNRQ_PAYMENT_FREQUENCY_DAY_1, 
	LNRQ_PAYMENT_FREQUENCY_DAY_2,
	LNRQ_PAYMENT_SKIP_COUNT, 
	LNRQ_PAYMENT_SKIP_START_MONTH, 
	LNRQ_PAYMENT_SKIP_START_DAY, 
	LNRQ_PAYMENT_AHEAD, 
	LNRQ_PAYMENT_AHEAD_COUNT, 
	LNRQ_PAYMENT_DUE_DATE, 
	LNRQ_BALLOON_DATE, 
	LNRQ_BALLOON_AMOUNT, 
	LNRQ_INTEREST_PREPAID, 
	LNRQ_INTEREST_CALCULATION_DATE, 
	LNRQ_INTEREST_RATE, 
	LNRQ_INTEREST_APR, 
	LNRQ_INTEREST_RATE_VAR_OPT, 
	LNRQ_INTEREST_RATE_INDEX_SERIAL, 
	LNRQ_INTEREST_RATE_MARGIN, 
	LNRQ_INTEREST_RATE_DISCOUNT, 
	LNRQ_INTEREST_RATE_RISK_PREMIUM, 
	LNRQ_INTEREST_RATE_MINIMUM, 
	LNRQ_INTEREST_RATE_MAXIMUM, 
	LNRQ_INTEREST_RATE_CHG_START_DATE, 
	LNRQ_INTEREST_RATE_CHG_SCH_FREQ, 
	LNRQ_INTEREST_RATE_CHG_SCH_FREQ_1, 
	LNRQ_INTEREST_RATE_CHG_SCH_FREQ_2, 
	LNRQ_INTEREST_RATE_CHG_SCH_PERIOD, 
	LNRQ_INTEREST_RATE_CHG_SCH_DATE, 
	LNRQ_INTEREST_RATE_CHG_SCH_RND_INC,
	LNRQ_INTEREST_RATE_CHG_SCH_RND_OPT, 
	LNRQ_INTEREST_RATE_CAP_FREQUENCY, 
	LNRQ_INTEREST_RATE_CAP_PERIOD, 
	LNRQ_INTEREST_RATE_CAP_DIRECTION, 
	LNRQ_INTEREST_RATE_CAP_START_DATE, 
	LNRQ_INTEREST_RATE_CAP_START_RATE, 
	LNRQ_INTEREST_RATE_CAP, 
	LNRQ_INTEREST_RATE_ADJUSTMENT, 
	LNRQ_INTEREST_RATE_ADJ_RSN_SERIAL, 
	LNRQ_LATE_FEE_CALCULATION_SERIAL, 
	LNRQ_MAINTENANCE_FEE_SERIAL, 
	LNRQ_MAINTENANCE_FEE_EFFECT_DATE, 
	LNRQ_MAINTENANCE_FEE_EXPIRE_DATE, 
	LNRQ_IMPOUND_AMOUNT, 
	LNRQ_IMPOUND_SHARE_SERIAL, 
	LNRQ_FASB_91_TYPE_SERIAL, 
	LNRQ_FASB_91_ORIGINAL_APR, 
	LNRQ_FASB_91_EFFECTIVE_APR, 
	LNRQ_FASB_91_UNAMORTIZED_FEES, 
	LNRQ_FASB_91_AMORTIZATION_AMOUNT, 
	LNRQ_FASB_91_FUNDING_OPTION, 
	LNRQ_MAIL_PERSON_ADDR_LINK_SERIAL, 
	LNRQ_STMT_MAIL_GROUP_SERIAL, 
	LNRQ_STMT_CUTOFF_GROUP_SERIAL, 
	LNRQ_CC_PURCH_INT_RATE, 
	LNRQ_CC_PURCH_INT_RATE_VAR_OPT, 
	LNRQ_CC_CASH_ADV_INT_RATE, 
	LNRQ_CC_CASH_ADV_INT_RATE_VAR_OPT, 
	LNRQ_CC_BAL_XFR_INT_RATE, 
	LNRQ_CC_BAL_XFR_INT_RATE_VAR_OPT, 
	LNRQ_CC_FIRST_YEAR_FEES_MAXIMUM, 
	LNRQ_CC_PENALTY_INT_RATE, 
	LNRQ_PROMO_RATE_TYPE_SERIAL, 
	LNRQ_SEGMENT_COUNT_LIMIT, 
	LNRQ_TAX_PERSON_SERIAL, 
	LNRQ_MLA_LIMITATION, 
	LNRQ_LIFE_INSURANCE_SERIAL, 
	LNRQ_DISABILITY_INSURANCE_SERIAL, 
	LNRQ_SINGLE_PREMIUM_LIFE, 
	LNRQ_SINGLE_PREMIUM_DISABILITY, 
	LNRQ_INSURANCE_METHOD, 
	LNRQ_INSURANCE_SHARE_SERIAL, 
	LNRQ_WITHDRAWN_INDICATOR, 
	LNRQ_CONTRACT_DATE, 
	LNRQ_SHARED_COLLATERAL_OPTION, 
	DW_LOAD_DT	
	)

	SELECT 
	stg.SERIAL,
	1,
	CURRENT_DATE,
	NULL,
	stg.SOURCEHASH2,
	stg.PARENT_SERIAL, 
	stg.ORDINAL, 
	stg.LAST_FM_DATE, 
	stg.ID, 
	stg.DESCRIPTION, 
	stg.TYPE_SERIAL, 
	stg.BRANCH_SERIAL, 
	stg.CRED_REP_PRIMARY_ECOA_CODE, 
	stg.CRED_REP_ACCOUNT_TYPE, 
	stg.CRED_REP_PORTFOLIO_TYPE_OVR, 
	stg.SHARED_BRANCH_OPTION, 
	stg.SOURCE_LOAN_SERIAL, 
	stg.PROJECTION_DESCRIPTION, 
	stg.PROJECTION_METHOD, 
	stg.MATURITY_DATE, 
	stg.PURPOSE_SERIAL, 
	stg.PROCESSOR_USER_SERIAL, 
	stg.APPROVAL_OFFICER_SERIAL, 
	stg.APPROVAL_DATE, 
	stg.APPROVED_LOAN_SERIAL, 
	stg.CREDIT_SCORE_CATEGORY, 
	stg.CREDIT_SCORE, 
	stg.PAPER_GRADE_SERIAL, 
	stg.COLLATERAL_TYPE_SERIAL,
	stg.NOTE_NUMBER, 
	stg.MINIMUM_BALANCE, 
	stg.MINIMUM_ADVANCE, 
	stg.DOWN_PAYMENT, 
	stg.CREDIT_LIMIT, 
	stg.CREDIT_LIMIT_EXPIRATION_DATE, 
	stg.CREDIT_LIMIT_SHARED_GRP_SERIAL, 
	stg.CC_CASH_ADV_LIMIT_PERCENTAGE, 
	stg.CC_CASH_ADV_LIMIT_AMOUNT, 
	stg.POSITIVE_PAY_OPTION, 
	stg.DRAW_PERIOD_EXPIRATION_DATE, 
	stg.MAX_VALUATION_CREDIT_LIMIT, 
	stg.SHARE_SECURED_OPTION, 
	stg.SHARE_SECURED_AMOUNT, 
	stg.PAYMENT_METHOD, 
	stg.PAYMENT_AMOUNT, 
	stg.PAYMENT_CALCULATION_SERIAL, 
	stg.PAYMENT_CALCULATION_SCH_FREQ, 
	stg.PAYMENT_CALCULATION_SCH_FREQ_1, 
	stg.PAYMENT_CALCULATION_SCH_PERIOD, 
	stg.PAYMENT_CALCULATION_SCH_DATE, 
	stg.PAYMENT_COUNT_SCHEDULED, 
	stg.PAYMENT_FREQUENCY, 
	stg.PAYMENT_FREQUENCY_DAY_1, 
	stg.PAYMENT_FREQUENCY_DAY_2, 
	stg.PAYMENT_SKIP_COUNT, 
	stg.PAYMENT_SKIP_START_MONTH, 
	stg.PAYMENT_SKIP_START_DAY, 
	stg.PAYMENT_AHEAD, 
	stg.PAYMENT_AHEAD_COUNT, 
	stg.PAYMENT_DUE_DATE, 
	stg.BALLOON_DATE, 
	stg.BALLOON_AMOUNT, 
	stg.INTEREST_PREPAID, 
	stg.INTEREST_CALCULATION_DATE, 
	stg.INTEREST_RATE, 
	stg.INTEREST_APR, 
	stg.INTEREST_RATE_VAR_OPT, 
	stg.INTEREST_RATE_INDEX_SERIAL, 
	stg.INTEREST_RATE_MARGIN, 
	stg.INTEREST_RATE_DISCOUNT, 
	stg.INTEREST_RATE_RISK_PREMIUM, 
	stg.INTEREST_RATE_MINIMUM, 
	stg.INTEREST_RATE_MAXIMUM, 
	stg.INTEREST_RATE_CHG_START_DATE, 
	stg.INTEREST_RATE_CHG_SCH_FREQ, 
	stg.INTEREST_RATE_CHG_SCH_FREQ_1, 
	stg.INTEREST_RATE_CHG_SCH_FREQ_2, 
	stg.INTEREST_RATE_CHG_SCH_PERIOD, 
	stg.INTEREST_RATE_CHG_SCH_DATE, 
	stg.INTEREST_RATE_CHG_SCH_RND_INC, 
	stg.INTEREST_RATE_CHG_SCH_RND_OPT, 
	stg.INTEREST_RATE_CAP_FREQUENCY, 
	stg.INTEREST_RATE_CAP_PERIOD, 
	stg.INTEREST_RATE_CAP_DIRECTION, 
	stg.INTEREST_RATE_CAP_START_DATE, 
	stg.INTEREST_RATE_CAP_START_RATE, 
	stg.INTEREST_RATE_CAP, 
	stg.INTEREST_RATE_ADJUSTMENT, 
	stg.INTEREST_RATE_ADJ_RSN_SERIAL, 
	stg.LATE_FEE_CALCULATION_SERIAL, 
	stg.MAINTENANCE_FEE_SERIAL, 
	stg.MAINTENANCE_FEE_EFFECT_DATE, 
	stg.MAINTENANCE_FEE_EXPIRE_DATE, 
	stg.IMPOUND_AMOUNT, 
	stg.IMPOUND_SHARE_SERIAL, 
	stg.FASB_91_TYPE_SERIAL, 
	stg.FASB_91_ORIGINAL_APR, 
	stg.FASB_91_EFFECTIVE_APR, 
	stg.FASB_91_UNAMORTIZED_FEES, 
	stg.FASB_91_AMORTIZATION_AMOUNT, 
	stg.FASB_91_FUNDING_OPTION, 
	stg.MAIL_PERSON_ADDR_LINK_SERIAL, 
	stg.STMT_MAIL_GROUP_SERIAL, 
	stg.STMT_CUTOFF_GROUP_SERIAL, 
	stg.CC_PURCH_INT_RATE, 
	stg.CC_PURCH_INT_RATE_VAR_OPT, 
	stg.CC_CASH_ADV_INT_RATE, 
	stg.CC_CASH_ADV_INT_RATE_VAR_OPT, 
	stg.CC_BAL_XFR_INT_RATE, 
	stg.CC_BAL_XFR_INT_RATE_VAR_OPT, 
	stg.CC_FIRST_YEAR_FEES_MAXIMUM, 
	stg.CC_PENALTY_INT_RATE, 
	stg.PROMO_RATE_TYPE_SERIAL, 
	stg.SEGMENT_COUNT_LIMIT, 
	stg.TAX_PERSON_SERIAL, 
	stg.MLA_LIMITATION, 
	stg.LIFE_INSURANCE_SERIAL, 
	stg.DISABILITY_INSURANCE_SERIAL, 
	stg.SINGLE_PREMIUM_LIFE, 
	stg.SINGLE_PREMIUM_DISABILITY, 
	stg.INSURANCE_METHOD, 
	stg.INSURANCE_SHARE_SERIAL, 
	stg.WITHDRAWN_INDICATOR, 
	stg.CONTRACT_DATE, 
	stg.SHARED_COLLATERAL_OPTION,
	CURRENT_DATE
	FROM RRCU_STG_DEV.KEYSTONE_CORE.T_KS_LOAN_REQUEST_STG_CF stg
		WHERE ISNEW = 1 OR ISTYPE2 = 1;
	
	-- Business rules around dates for current records
	UPDATE RRCU_DW_DEV.DW.T_KS_LOAN_REQUEST_DW_CF
	SET LNRQ_CURR_IND = 0
	, LNRQ_EXP_DT = CURRENT_DATE
	WHERE LNRQ_MATURITY_DATE <= CURRENT_DATE
	AND LNRQ_CURR_IND = 1;

	UPDATE RRCU_DW_DEV.DW.T_KS_LOAN_REQUEST_DW_CF
	SET LNRQ_CURR_IND = 0
	, LNRQ_EXP_DT = CURRENT_DATE
	WHERE LNRQ_WITHDRAWN_INDICATOR <> '-';

END;
$$
;
